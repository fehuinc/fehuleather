<h1>It's Checkout Time</h1>

<section>
  <h3>You're about to order <%= link_to "#{@items_count} item".pluralize(@items_count), edit_wholesale_path %>.</h3>
  
  <div class="little-preview">
    <% @order.items.each do |item| %>
      <% item.quantity.times do %>
        <div>
          <%= image_tag item.build.variation.wholesale_image if item.build.variation.wholesale_image %>
        </div>
      <% end %>
    <% end %>
  </div>
</section>

<section ng-cloak>
  <h2>Where should we ship it to?</h2>
  
  <div class="addresses">
    <% @merchant.addresses.each do |address| %>
      <div class="address" ng-click="shipTo = <%=address.id%>; email = '<%=address.email%>'" ng-class="{selected:shipTo == <%=address.id%>}">
        <div class="info">
          <%= address.name %><br>
          <%= address.line1 %><br>
          <% if address.line2.present? %>
            <%= address.line2 %><br>
          <% end %>
          <%= address.city %>, <%= address.region %><br>
          <%= address.code %> <%= address.country %>
        </div>
        <div class="edit">
          <%= link_to "Edit", edit_merchant_address_path(address) %>
        </div>
      </div>
    <% end %>
  </div>
  
  <div class="perspective in-bl">
    <%= link_to "New Address", new_merchant_address_path, class: "button" %>
  </div>
</section>

<section ng-cloak ng-show="shipTo != null">
  <label class="preferedDate">
    Preferred delivery date (optional, best effort)
    <input ng-model="preferredDate" type="text">
  </label>
  <label class="notes">
    Notes (optional)
    <textarea ng-model="notes"></textarea>
  </label>
</section>

<section class="payment" ng-cloak ng-show="shipTo">
  
  <div class="radios">
    <h4>How would you like to pay?</h4>
    <div>
      <label><input type="radio" ng-model="paymentMethod" value="creditCard">Credit Card</label>
      <label><input type="radio" ng-model="paymentMethod" value="eTransfer">e-Transfer</label>
      <label><input type="radio" ng-model="paymentMethod" value="cheque">Cheque</label>
      <label><input type="radio" ng-model="paymentMethod" value="other">Other</label>
    </div>
    <label class="paymentMethodText" ng-show="paymentMethod == 'other'">
      Please specify
      <input type="text" ng-model="paymentMethodText">
    </label>
  </div>
  
  <div class="radios" ng-show="paymentMethod == 'creditCard'">
    <h4>When would you like to pay?</h4>
    <div>
      <label><input type="radio" ng-model="paymentTime" value="now">I will pay now</label>
      <label><input type="radio" ng-model="paymentTime" value="beforeShip">Send me an invoice</label>
      <label><input type="radio" ng-model="paymentTime" value="net30">I'd like to request Net 30</label>
      <label><input type="radio" ng-model="paymentTime" value="other">Other</label>
    </div>
    <label ng-show="paymentTime == 'other'">
      Please specify
      <input type="text" ng-model="paymentTimeText">
    </label>
  </div>
</section>

<section ng-cloak ng-show="paymentMethod == 'creditCard' && paymentTime == 'now'">
  <%= form_tag submit_wholesale_path, class: "stripe perspective in-bl" do |f| %>
    
    <input type="hidden" name="shippingAddressId" value="{{shipTo | json}}">
    <input type="hidden" name="email" value="{{email}}">
    <input type="hidden" name="subtotal" value="<%= @order.subtotal.to_i %>">
    <input type="hidden" name="description" value="<%= "#{@items_count} Wholesale Item".pluralize(@items_count) %>">
    <input type="hidden" name="notes" value="{{notes | json}}">
    
    <script src="https://checkout.stripe.com/checkout.js"></script>
    
    <button>Pay With Credit Card</button>
  <% end %>
</section>
  
<section ng-cloak ng-hide="paymentMethod == null || (paymentMethod == 'creditCard' && (paymentTime == null || paymentTime == 'now'))">
  
  <div class="additionalInfo" ng-show="paymentMethod == 'eTransfer'">
    Please send an e-Transfer to <em>freyja@fehuleather.com</em> with <em>cufflove</em> as the password.
    We'll ship the order after the payment goes through.
  </div>
  
  <div class="additionalInfo">
    <div ng-show="paymentMethod == 'cheque' && requestNet30">
      We'll get in touch with you shortly to decide if you qualify.
    </div>
    
    <div ng-show="paymentMethod == 'cheque' && !requestNet30">
      We will wait until we receive the cheque before shipping your order.
    </div>

    <div ng-show="paymentMethod == 'cheque'">
      <label><input type="checkbox" ng-model="requestNet30"> Request Net 30</label>
    </div>
  </div>
    
  <div class="perspective in-bl">
    <button>Submit Order</button>
  </div>
</section>
