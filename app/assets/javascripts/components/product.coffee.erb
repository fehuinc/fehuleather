angular.module "Product", []

.directive "product", ()->
  templateUrl: "<%= asset_path('components/product.html') %>"
  
  controller: new Array "$scope", ($scope)->
    
    ## LOCALS
    productIndex = $scope.$index
    
    
    ## SCOPE LOCALS
    $scope.specimen = $scope.product.specimens[0]
    $scope.product.variations[0].choice = $scope.product.variations[0].variants[0]
    
    
    ## HELPERS
    getSpecimenIndex = (rawIndex)->
      specimens = $scope.product.specimens
      return (rawIndex + specimens.length) % specimens.length
    
    getSpecimen = (specimenIndex)->
      return $scope.product.specimens[getSpecimenIndex(specimenIndex)]
    
    
    ## SCOPE
    $scope.specimensCount = ()->
      return $scope.product.specimens.length
    
    $scope.getTotemImage = (specimenIndex)->
      return getSpecimen(specimenIndex)?.totem
    
    $scope.getVerticalPositionStyle = ()->
      ypos = if $scope.infoIsOpen(productIndex) then $scope.product.ypos else 0
      translate = "translate(-50%, -#{ypos}%)"
      return style =
        transform: translate
        "-webkit-transform": translate
    
    $scope.changeSpecimen = (specimenIndex)->
      $scope.specimen = getSpecimen(specimenIndex)
      $scope.product.variations[0].choice = $scope.product.variations[0].variants[getSpecimenIndex(specimenIndex)]
    
    $scope.checkChange = (variationIndex)->
      if variationIndex is 0
        ""
        # We need to change to the right specimen for the selected variant
        # $scope.changeSpecimen(variationIndex)
      
