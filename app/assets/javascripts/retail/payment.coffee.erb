Take ["CartDB", "DOMContentLoaded"], (CartDB)->
  if $(".stripe button").length > 0
    
    processing = false
    form = $ "form.stripe"
    
    handler = StripeCheckout.configure
      key: "<%= ENV['STRIPE_KEY'] %>"
      name: "Fehu Inc."
      # image: "<%= image_path 'logo-square-blue.png' %>"
      token: (token)->
        processing = false
        form.append("<input type='hidden' name='token' value='#{token.id}'>")
        form.submit()
        
        # Use the token to create the charge with a server-side script.
        # You can access the token ID with `token.id`
    
    $(".stripe button").click (e)->
      e.preventDefault()
      if not processing
        processing = true
        handler.open
          amount: CartDB.getSubtotalCents()
          description: CartDB.getQuantity() + " Items"
          email: $(".email").text()
          currency: 'CAD'
